{% extends 'layout/base.html' %}

{% block title %}
Thông tin tài khoản
{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Card Profile -->
    <div class="card bg-sp">
        <div class="row g-0">
            <div class="col-md-4 d-flex justify-content-center align-items-center">
                <!-- Ảnh đại diện -->
                <img src="{{ current_user.avatar }}" class="rounded-circle" width="200">
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <div class="row">
                        <h5 class="card-title col-lg-10 col-md-12 text-center">Thông tin cá nhân</h5>
                    </div>
                    <p class="card-text">Họ tên: {{current_user.name}}</p>
                    <p class="card-text">Số dư: <span style="font-weight: 500">{{ "{:,.0f}".format(current_user.balance) }} đ </span>
                    </p>
                    <!--                    <div class="row">-->
                    <!--                        <p class="card-text col-lg-6">Ngày sinh: </p>-->
                    <!--                        <p class="card-text col-lg-6" style="margin-bottom: 1rem;">Giới tính: </p>-->
                    <!--                    </div>-->
                    <div class="row">
                        <p class="card-text col-lg-6">Email: {% if current_user.email %} {{current_user.email}} {% else %} Chưa cập nhật {% endif%} </p>
                        <p class="card-text col-lg-6" style="margin-bottom: 1rem;">Số điện thoại: {% if current_user.phone_number %} {{ current_user.phone_number }} {% else %} Chưa cập nhật {% endif %} </p>
                    </div>
                    <p class="card-text"><small class="text-muted">Ngày tham gia: {% if current_user.created_at
                        %}{{current_user.created_at.strftime("%H:%M-%d/%m/%Y") }} {% endif %}</small></p>
                    <div class="text-end">
                        <a class="btn btn-sm btn-dark pr-2 pl-2" data-bs-toggle="modal"
                           data-bs-target="#editPasswordModal">Đổi mật khẩu</a>
                        <a class="btn btn-sm btn-outline-dark pr-2 pl-2" data-bs-toggle="modal"
                           data-bs-target="#editInfoModal">Sửa thông tin</a>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Nút chỉnh sửa thông tin -->
    <!--    <div class="mt-4 d-flex justify-content-center mb-4">-->
    <!--        <a href="#" class="btn btn-primary">Chỉnh sửa thông tin</a>-->
    <!--    </div>-->


    <div class="my-4">
        <div class="container">
            <h1 class="text-center mb-4">Danh sách đơn hàng đã mua</h1>

            <!-- Danh sách đơn hàng -->
            {% if orders %}
            <div class="accordion" id="orderAccordion">
                {% for order in orders %}
                <div class="accordion-item bg-sp">
                    <h2 class="accordion-header" id="heading{{ order.id }}">
                        <button class="btn w-100 text-start d-flex justify-content-between align-items-center"
                                type="button" style="border: 1px solid #000000;"
                                data-bs-toggle="collapse" data-bs-target="#collapse{{ order.id }}"
                                aria-expanded="true" aria-controls="collapse{{ order.id }}">
                            <span>Đơn hàng #{{ order.id }} - Tổng tiền: {{ "{:,.0f}".format(order.total_price) }} VNĐ</span>
                            <span>Ngày đặt: {{ order.created_at.strftime("%H:%M %d/%m/%Y") }}</span>
                        </button>
                    </h2>
                    <div id="collapse{{ order.id }}" class="accordion-collapse collapse bg-main"
                         aria-labelledby="heading{{ order.id }}"> <!--data-bs-parent="#orderAccordion"-->
                        <div class="accordion-body">
                            <p><strong>Trạng thái:</strong>
                                {% if order.status.name == 'SUCCESS' %} <span
                                        style="color: #32CD32">Đã thanh toán</span> {% endif %}
                                {% if order.status.name == 'PENDING' and not order.is_paid %} <span
                                        style="color: #FF0000">Chờ thanh toán tại cửa hàng - Tự hủy lúc {{ order.time_to_cancel.strftime("%H:%M:%S %d/%m/%Y") }} </span>
                                {% endif %}
                                {% if order.status.name == 'PENDING' and order.is_paid %} <span style="color: #32CD32">Đã thanh toán</span>{%
                                endif %}
                                {% if order.status.name == 'CANCEL' %} <span style="color: #FF0000">Đã hủy</span> {%
                                endif %}
                            </p>
                            <p><strong>Hình thức mua:</strong>
                                {% if order.order_type.name == "ONLINE" %} <span>Mua tại website</span> {% endif %}
                                {% if order.order_type.name == "OFFLINE" %} <span>Mua tại cửa hàng</span> {%
                                endif %}
                            </p>
                            <p><strong>Nhận hàng:</strong>
                                {% if order.is_shipped %} <span>Đã nhận hàng</span> {% endif %}
                                {% if not order.is_shipped %} <span style="color: #FF0000">Chưa nhận hàng</span> {%
                                endif %}
                            </p>

                            <!-- Chi tiết đơn hàng -->
                            <h5 class="mt-3">Chi tiết đơn hàng:</h5>
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Sách</th>
                                    <th>Đơn giá</th>
                                    <th>Số lượng</th>
                                    <th>Tổng</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for detail in order.order_detail %}
                                <tr>
                                    <td>{{ detail.book.name }}</td>
                                    <td>{{ "{:,.0f}".format(detail.unit_price) }} VNĐ</td>
                                    <td>{{ detail.quantity }}</td>
                                    <td>{{ "{:,.0f}".format(detail.sub_total) }} VNĐ</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>

                            <h5 class="text-end">Tổng tiền: <strong>{{ "{:,.0f}".format(order.total_price) }}
                                VNĐ</strong></h5>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!--pagination-->
            <div>
                {% if pages > 1 %}
                <ul class="pagination bg-main justify-content-center my-3">
                    <li class="page-item"><a class="page-link bg-main" href="/profile?page={{page-1}}"
                                             style="color: #887d55; {% if page == 1 %} pointer-events: none; {% endif %}">Previous</a>
                    </li>
                    {% for i in range(1, pages + 1) %}
                    <li class="page-item"><a class="page-link bg-main" href="/profile?page={{i}}"
                                             style="color: #887d55; {% if i == page %} text-decoration: underline; background-color: #bfbaaf; {% endif %}">{{i}}</a>
                    </li>
                    {% endfor %}
                    <li class="page-item"><a class="page-link bg-main" href="/profile?page={{page+1}}"
                                             style="color: #887d55; {% if page == pages %} pointer-events: none; {% endif %}">Next</a>
                    </li>

                </ul>
                {% endif %}
            </div>
            {% else %}
            <div class="alert bg-sp text-center">
                Không có đơn hàng nào!
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if current_user.is_authenticated %}
<div class="modal fade" id="editInfoModal" tabindex="-1" aria-labelledby="editInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header" style="background-color: #d7d0bf">
                <h5 class="modal-title" id="editInfoModalLabel">Chỉnh sửa thông tin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>

            <div class="modal-body bg-main">
                <form id="editInfoForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Họ tên</label>
                        <input type="text" class="form-control bg-sp" id="name" name="name"
                               value="{{ current_user.name }}"/>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control bg-sp" id="email" name="email"
                               value="{% if current_user.email %} {{ current_user.email }} {% endif %}">
                    </div>

                    <div class="mb-3">
                        <label for="phone" class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control bg-sp" id="phone" name="phone"
                               value="{% if current_user.phone_number %} {{ current_user.phone_number }} {% endif %}">
                    </div>

                    <div class="d-flex justify-content-center mt-5 mb-3">
                        <button class="btn" style="border: 1px solid; background-color: #d7d0bf" type="submit">Xác
                            nhận
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editPasswordModal" tabindex="-1" aria-labelledby="editPasswordModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header" style="background-color: #d7d0bf">
                <h5 class="modal-title" id="editPasswordModalLabel">Đổi mật khẩu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>

            <div class="modal-body bg-main">
                <div class="mb-3">
                    <label for="oldPassword" class="form-label">Nhập mật khẩu</label>
                    <input type="password" class="form-control bg-sp" id="oldPassword" name="old_password" required/>
                </div>

                <div class="mb-3">
                    <label for="newPassword" class="form-label">Mật khẩu mới</label>
                    <input type="password" class="form-control bg-sp" id="newPassword" name="new_password" required>
                </div>

                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                    <input type="password" class="form-control bg-sp" id="confirmPassword" name="confirm_password"
                           required>
                </div>

                <div class="d-flex justify-content-center mt-5 mb-3">
                    <button class="btn" style="border: 1px solid; background-color: #d7d0bf" id="submitChangPassword"
                            onclick="changePassword()">
                        Xác nhận
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% block js_internal %}
<script>
    function changePassword() {
        let oldPassword = document.getElementById("oldPassword").value.trim();
        let newPassword = document.getElementById("newPassword").value.trim();
        let confirmPassword = document.getElementById("confirmPassword").value.trim();

        if (!oldPassword || !newPassword || !confirmPassword) {
            alert("Vui lòng nhập đầy đủ thông tin.");
            return;
        }

        if (newPassword !== confirmPassword) {
            alert("Mật khẩu mới và xác nhận mật khẩu không khớp.");
            return;
        }

        fetch("/api/change_password", {
            method: 'POST',
            body: JSON.stringify({
                "old_password": oldPassword,
                "new_password": newPassword,
            }),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(res => {
            if (res.status === 400) {
                alert("Mật khẩu cũ không đúng");
                return
            }

            if (res.status === 200) {
                alert('Đổi mật khẩu thành công');
                window.location.reload();
            } else {
                return res.json().then(data => {
                    alert(data.message || "Lỗi không xác định.");
                });
            }
        }).catch(err => {
            alert('Đã sảy ra lỗi không xác định!');
            console.error('error: ', err)
        });
    }

    document.getElementById('editInfoForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();

        if (!name || !email) {
            alert("Họ tên và email không được để trống.");
            return;
        }

        fetch('/api/update_user_info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, email, phone })
        })
        .then(res => res.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
                window.location.reload();
            } else {
                alert(data.error || "Đã xảy ra lỗi.");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Đã xảy ra lỗi không xác định.");
        });
    });
</script>
{% endblock %}


{% endblock %}