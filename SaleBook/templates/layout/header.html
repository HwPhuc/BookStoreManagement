<header class="shadow-sm position-sticky top-0 pt-1 bg-main" style="z-index: 1000;">
    <nav class="navbar navbar-expand-lg ps-md-4 pe-md-4">
        <div class="container-fluid d-flex">

            <!-- start: 25% -->
            <!-- Nút toggle menu và logo -->
            <div class="d-flex justify-content-start " style="width: 25%;">
                <button class="btn p-0 me-3 d-lg-none" type="button" data-bs-toggle="collapse"
                        data-bs-target="#sidebarMenu" aria-expanded="false" aria-controls="sidebarMenu">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <a class="navbar-brand fw-bold text-dark" href="/">BOOK SHOP</a>
            </div>


            <!-- Menu danh mục cho màn hình lớn -->
            <div class="d-none me-2 d-lg-flex align-items-center ms-3">
                <div class="dropdown">
                    <button class="btn btn-outline-dark dropdown-toggle" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Danh mục
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
                        {% for category in categories %}
                        <li>
                            <a class="dropdown-item" href="/?category_id={{ category.id }}">{{ category.name }}</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>


            <!-- center: 50% -->
            <!-- Thanh tìm kiếm (Màn hình lớn) -->
            <div class="d-flex justify-content-center" style="width: 45%;">
                <div class="d-none d-lg-flex flex-grow-1">
                    <form class="d-flex w-100" role="search" method="get" action="/">
                        <input class="form-control me-2 bg-main" type="search" placeholder="Tìm kiếm"
                               aria-label="Search"
                               name="search_query" value="{{ request.args.get('search_query', '') }}">
                        <button class="btn btn-outline-dark" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                </div>
            </div>


            <!-- end: 25% -->
            <!-- Login và register-->
            <!-- Giỏ hàng và avatar và nút tìm kiếm màn hình nhỏ -->
            <div class="d-flex justify-content-end" style="width: 25%;">
                <!-- Nút tìm kiếm màn hình nhỏ-->
                <button class="btn p-0 d-lg-none me-1" type="button" data-bs-toggle="collapse"
                        data-bs-target="#searchBar" aria-expanded="false" aria-controls="searchBar">
                    <i class="bi bi-search fs-4"></i>
                </button>

                {% if current_user.is_authenticated %}
                <!-- Số dư tài khoảng-->
                <div class="d-none align-items-center me-2 d-lg-flex">
                    <i class="bi bi-wallet2 me-1 fs-5"></i>
                    {{ "{:,.0f}".format(current_user.balance ) }} VNĐ
                </div>

                <!-- Biểu tượng giỏ hàng-->
                <a href="/cart" class="btn position-relative me-2">
                    <i class="bi bi-cart fs-4"></i>
                    <!-- Hiển thị số lượng giỏ hàng -->
                    <span class="position-absolute top-0 translate-middle badge rounded-pill bg-danger mt-3 cart-counter">{{ cart_stats.total_quantity }}</span>
                </a>

                <!-- Icon đăng nhập dropdown-->
                <div class="dropdown d-flex justify-content-center align-items-center ms-1 active">
                    <a href="#" class="" id="userDropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="{{ current_user.avatar }}" class="rounded-circle" width="25">
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end bg-sp" aria-labelledby="userDropdownUser">
                        <li><a class="dropdown-item" href="/profile">Tài khoản của tôi</a></li>
                        <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#topUpModal" href="">Nạp tiền</a>
                        <li><a class="dropdown-item" href="/wallet_log">Lịch sử giao dịch</a></li>
                        </li>
                        {% if dashboard %}
                        <li><a class="dropdown-item" href="{{ dashboard }}">Bảng điều khiển của tôi</a></li>
                        {% endif %}
                        <li><a class="dropdown-item" href="/logout">Đăng xuất</a></li>
                    </ul>
                </div>
                {% else%}
                <a class="btn btn-outline-dark ms-2 pt-1 d-none d-lg-block" href="/login">Đăng nhập</a>
                <a class="btn btn-dark ms-2 pt-1 d-none d-lg-block" href="/register">Đăng kí</a>
                <a href="#" class="btn d-lg-none" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle fs-4"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end bg-sp" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="/login">Đăng nhập</a></li>
                    <li><a class="dropdown-item" href="/register">Đăng kí</a></li>
                </ul>
                {% endif %}
            </div>


             <!-- Menu danh mục cho màn hình nhỏ -->
            <div class="collapse mt-2 d-lg-none" id="sidebarMenu">
                <ul class="navbar-nav">
                    {% for category in categories %}
                    <li class="nav-item">
                        <a class="nav-link" href="/?category_id={{ category.id }}">{{ category.name }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>


            <!-- Thanh tìm kiếm trên màn hình nhỏ -->
            <div class="collapse mt-2 flex-grow-1 d-lg-none" id="searchBar">
                <form class="d-flex" role="search" method="get">
                    <input class="form-control me-2 bg-main" type="search" placeholder="Tìm kiếm..." aria-label="Search"
                           name="search_query">
                    <button class="btn btn-outline-dark" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>
</header>

{% if current_user.is_authenticated %}
<div class="modal fade" id="topUpModal" tabindex="-1" aria-labelledby="topUpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #d7d0bf">
                <h5 class="modal-title" id="topUpModalLabel">Thông tin nạp tiền</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body bg-main">
                <div class="mb-3">
                    <label for="amount_display" class="form-label">Số tiền cần nạp</label>
                    <input type="text" class="form-control bg-sp" id="amount_display" placeholder="Nhập số tiền..."
                           oninput="formatCurrency(this)" />
                </div>

                <input type="hidden" id="amount" name="amount">

                <div class="mb-3">
                    <label for="topupMethod" class="form-label">Phương thức thanh toán</label>
                    <select class="form-select bg-sp" id="topupMethod">
                        <option value="credit">Thẻ tín dụng</option>
                    </select>
                </div>
                <div class="d-flex justify-content-center mt-5 mb-3">
                    <button class="btn" style="border: 1px solid; background-color: #d7d0bf" id="top-up" onclick="submitTopUp()">Xác nhận
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% block js_internal %}
<script>
    function formatCurrency(input) {
        let rawValue = input.value.replace(/\D/g, ''); // Chỉ giữ số

        if (rawValue === "") {
            input.value = "";
            return;
        }

        let formatted = new Intl.NumberFormat('vi-VN').format(rawValue);
        input.value = formatted;

        // Cập nhật lại vị trí con trỏ
        input.setSelectionRange(input.value.length, input.value.length);

        // Nếu bạn có input hidden để lưu giá trị số thực:
        document.getElementById("amount").value = rawValue;
    }

    function submitTopUp() {
        let amount = Number(document.getElementById("amount").value);

        if (amount < 20000) {
            alert("Nạp tối thiểu 20.000 vnđ");
        } else {
            if (amount && Number.isInteger(amount)) {
            topUp(amount);
            } else {
                alert("Vui lòng nhập số tiền hợp lệ");
            }
        }
    }
</script>
{% endblock %}

